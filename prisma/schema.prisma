// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ====================================================================
// I. 基盤
// ====================================================================

// 1. ユーザー (users)
model User {
  id                 Int                 @id @default(autoincrement())
  userId             String              @unique @map("user_id")
  name               String?             // PostgresではデフォルトでText型
  email              String              @unique
  hashedPassword     String?             @map("hashed_password")
  image              String?
  bio                String?
  isAdmin            Boolean             @default(false) @map("is_admin")
  courseCount        Int                 @default(0) @map("course_count")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  lastLoggedInAt     DateTime?           @map("last_logged_in_at")
  emailVerified      DateTime?           @map("email_verified")

  // リレーション
  courses            Course[]
  wantsToEatRecords  WantsToEat[]
  comments           Comment[]
  triedRecords       Tried[]
  ratings            Rating[]
  contactSubmissions ContactSubmission[]
  accounts           Account[]
  sessions           Session[]

  @@map("users")
}

// ====================================================================
// II. カタログ/マスター
// ====================================================================

// 2. 冷凍食品カタログ (products)
model Product {
  id                 Int                 @id @default(autoincrement())
  name               String
  manufacturer       String
  description        String?
  janCode            String?             @unique @map("jan_code")
  imageUrl           String?             @map("image_url")
  officialUrl        String?             @map("official_url")
  priceReference     Int?                @map("price_reference") 
  priceUnitQty       String?             @map("price_unit_qty")
  isOnSale           Boolean             @default(true) @map("is_on_sale")
  amazonAsin         String?             @map("amazon_asin")
  amazonUrl          String?             @map("amazon_url")
  amazonPrice        Int?                @map("amazon_price")
  rakutenUrl         String?             @map("rakuten_url")
  rakutenPrice       Int?                @map("rakuten_price")
  yahooUrl           String?             @map("yahoo_url")
  yahooPrice         Int?                @map("yahoo_price")
  lastCheckedAt      DateTime?           @map("last_checked_at")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")

  // リレーション
  courseItems        CourseItem[]
  productCategories  ProductCategory[]

  @@map("products")
}

// 3. カテゴリマスター (categories)
model Category {
  id                  Int                 @id @default(autoincrement())
  name                String              @unique
  description         String?
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // リレーション
  productCategories   ProductCategory[]

  @@map("categories")
}

// 4. 商品カテゴリ中間 (product_categories)
model ProductCategory {
  productId           Int                 @map("product_id")
  categoryId          Int                 @map("category_id")

  // リレーション
  product             Product             @relation(fields: [productId], references: [id])
  category            Category            @relation(fields: [categoryId], references: [id])

  @@id([productId, categoryId])
  @@map("product_categories")
}

// ====================================================================
// III. コア/トランザクション
// ====================================================================

// 5. フルコース投稿 (courses)
model Course {
  id                  Int                 @id @default(autoincrement())
  title               String
  description         String?
  userId              Int                 @map("user_id")
  wantsToEatCount     Int                 @default(0) @map("wants_to_eat_count")
  triedCount          Int                 @default(0) @map("tried_count")
  averageRating       Decimal?            @db.Decimal(3, 2) @map("average_rating")
  commentCount        Int                 @default(0) @map("comment_count")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // リレーション
  user                User                @relation(fields: [userId], references: [id])
  courseItems         CourseItem[]
  wantsToEat          WantsToEat[]
  comments            Comment[]
  trieds              Tried[]
  ratings             Rating[]

  @@map("courses")
}

// 6. コース構成要素 (course_items)
model CourseItem {
  id                  Int                 @id @default(autoincrement())
  courseId            Int                 @map("course_id")
  productId           Int                 @map("product_id")
  order               Int
  role                String?

  // リレーション
  course              Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  product             Product             @relation(fields: [productId], references: [id])

  @@map("course_items")
}

// ====================================================================
// IV. コミュニティ
// ====================================================================

// 7. 評価 (ratings)
model Rating {
  id                  Int                 @id @default(autoincrement())
  courseId            Int                 @map("course_id")
  userId              Int                 @map("user_id")
  score               Int                 // @db.TinyInt削除 -> Int
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // リレーション
  course              Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user                User                @relation(fields: [userId], references: [id])

  @@unique([courseId, userId])
  @@map("ratings")
}

// 8. 食べたい履歴 (wants_to_eat)
model WantsToEat {
  id                  Int                 @id @default(autoincrement())
  courseId            Int                 @map("course_id")
  userId              Int                 @map("user_id")
  createdAt           DateTime            @default(now()) @map("created_at")

  // リレーション
  course              Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user                User                @relation(fields: [userId], references: [id])

  @@unique([courseId, userId])
  @@map("wants_to_eat")
}

// 9. コメント (comments)
model Comment {
  id                  Int                 @id @default(autoincrement())
  courseId            Int                 @map("course_id")
  userId              Int                 @map("user_id")
  content             String
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // リレーション
  course              Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user                User                @relation(fields: [userId], references: [id])

  @@map("comments")
}

// 10. 食べたよ履歴 (trieds)
model Tried {
  id                  Int                 @id @default(autoincrement())
  courseId            Int                 @map("course_id")
  userId              Int                 @map("user_id")
  createdAt           DateTime            @default(now()) @map("created_at")

  // リレーション
  course              Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user                User                @relation(fields: [userId], references: [id])

  @@unique([courseId, userId])
  @@map("trieds")
}

// 11. 問い合わせ（ContactSubmission）
enum SubmissionType {
  REQUEST
  BUG_REPORT
  ACCOUNT
  PRODUCT_REQUEST
  OTHER
}

enum SubmissionStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model ContactSubmission {
  id                  Int                 @id @default(autoincrement())
  userId              Int?                @map("user_id")
  user                User?               @relation(fields: [userId], references: [id])
  submitterName       String?             @map("submitter_name")
  submitterEmail      String              @map("submitter_email")
  type                SubmissionType
  title               String
  details             String
  status              SubmissionStatus    @default(OPEN)  
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  
  @@map("contact_submissions")
}

// ====================================================================
// V. NextAuth.js (Auth.js) 用の追加モデル
// ====================================================================

model Account {
  id                  String  @id @default(cuid())
  userId              Int     @map("user_id")
  type                String
  provider            String
  providerAccountId   String  @map("provider_account_id")
  refresh_token       String?
  access_token        String?
  expires_at          Int?
  token_type          String?
  scope               String?
  id_token            String?
  session_state       String? @map("session_state")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id                  String   @id @default(cuid())
  sessionToken        String   @unique @map("session_token")
  userId              Int      @map("user_id")
  expires             DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier          String
  token               String   @unique
  expires             DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// パスワードリセット用トークン
model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([email, token])
  @@map("password_reset_tokens")
}

// メール認証コード (email_verification_codes)
model EmailVerificationCode {
  id        Int      @id @default(autoincrement())
  email     String   @unique // 1つのメアドにつき最新の1コードのみ保持
  code      String
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("email_verification_codes")
}