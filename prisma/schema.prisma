// This is your Prisma schema file,
// learn more about it in the docs: https://pris.lyly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ====================================================================
// I. 基盤
// ====================================================================

// 1. ユーザー (users)
model User {
  id                 Int                 @id @default(autoincrement())
  name               String?             @db.VarChar(100)
  email              String              @unique @db.VarChar(100) // 認証用のユニークメールアドレス
  hashedPassword     String?             @db.VarChar(255) @map("hashed_password")// パスワードハッシュを格納するカラム(Auth.js関連)
  image              String?             @db.VarChar(255)
  bio                String?             @db.Text
  isAdmin            Boolean             @default(false) @map("is_admin")
  courseCount        Int                 @default(0) @map("course_count") // 投稿数カウンタ
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  lastLoggedInAt     DateTime?           @map("last_logged_in_at")
  // Auth.js連携用
  emailVerified      DateTime?           @map("email_verified")

  // リレーション
  courses            Course[]
  wantsToEatRecords  WantsToEat[]
  comments           Comment[]
  triedRecords       Tried[]
  ratings            Rating[]
  contactSubmissions ContactSubmission[]
  // Auth.js連携用
  accounts           Account[]
  sessions           Session[]

  @@map("users")
}

// ====================================================================
// II. カタログ/マスター
// ====================================================================

// 2. 冷凍食品カタログ (products)
model Product {
  id                 Int                 @id @default(autoincrement())
  name               String              @db.VarChar(100)
  manufacturer       String              @db.VarChar(50)
  description        String?             @db.Text
  janCode            String?             @unique @db.VarChar(13) @map("jan_code")
  imageUrl           String?             @db.VarChar(255) @map("image_url")
  officialUrl        String?             @db.VarChar(255) @map("official_url")
  priceReference     String?             @db.VarChar(20) @map("price_reference")
  priceUnitQty       String?             @db.VarChar(50) @map("price_unit_qty")
  isOnSale           Boolean             @default(true) @map("is_on_sale")
  amazonAsin         String?             @db.VarChar(10) @map("amazon_asin") // マネタイズ機能の準備
  lastCheckedAt      DateTime?           @map("last_checked_at")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")

  // リレーション
  courseItems        CourseItem[]
  productCategories  ProductCategory[]

  @@map("products")
}

// 3. カテゴリマスター (categories)
model Category {
  id                  Int                 @id @default(autoincrement())
  name                String              @unique @db.VarChar(50)
  description         String?             @db.Text
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // リレーション
  productCategories   ProductCategory[]

  @@map("categories")
}

// 4. 商品カテゴリ中間 (product_categories) - 多対多の中間テーブル
model ProductCategory {
  productId           Int                 @map("product_id")
  categoryId          Int                 @map("category_id")

  // リレーション
  product             Product             @relation(fields: [productId], references: [id])
  category            Category            @relation(fields: [categoryId], references: [id])

  @@id([productId, categoryId]) // 複合主キー
  @@map("product_categories")
}

// ====================================================================
// III. コア/トランザクション
// ====================================================================

// 5. フルコース投稿 (courses)
model Course {
  id                  Int                 @id @default(autoincrement())
  title               String              @db.VarChar(100)
  description         String?             @db.Text
  userId              Int                 @map("user_id")
  wantsToEatCount     Int                 @default(0) @map("wants_to_eat_count") // 食べたい数
  triedCount          Int                 @default(0) @map("tried_count")        // 食べたよ数
  averageRating       Decimal?            @db.Decimal(3, 2) @map("average_rating") // 平均評価点 (例: 4.50)
  commentCount        Int                 @default(0) @map("comment_count") // コメント数
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // リレーション
  user                User                @relation(fields: [userId], references: [id])
  courseItems         CourseItem[]
  wantsToEat          WantsToEat[]
  comments            Comment[]
  trieds              Tried[]
  ratings             Rating[]

  @@map("courses")
}

// 6. コース構成要素 (course_items)
model CourseItem {
  id                  Int                 @id @default(autoincrement())
  courseId            Int                 @map("course_id")
  productId           Int                 @map("product_id")
  order               Int                 // フルコース内での順番 (1:アミューズ, 6:デセールなど)
  role                String?             @db.VarChar(50)

  // リレーション
  course              Course              @relation(fields: [courseId], references: [id], onDelete: Cascade) // コース削除時、構成要素も削除
  product             Product             @relation(fields: [productId], references: [id])

  @@map("course_items")
}

// ====================================================================
// IV. コミュニティ
// ====================================================================

// 7. 評価 (ratings) - ユーザーごとの点数
model Rating {
  id                  Int                 @id @default(autoincrement())
  courseId            Int                 @map("course_id")
  userId              Int                 @map("user_id")
  score               Int                 @db.TinyInt
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // リレーション
  course              Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user                User                @relation(fields: [userId], references: [id])

  @@unique([courseId, userId]) // 1ユーザーが1コースに複数回評価できないようにする
  @@map("ratings")
}

// 8. 食べたい履歴 (wants_to_eat)
model WantsToEat {
  id                  Int                 @id @default(autoincrement())
  courseId            Int                 @map("course_id")
  userId              Int                 @map("user_id")
  createdAt           DateTime            @default(now()) @map("created_at")

  // リレーション
  course              Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user                User                @relation(fields: [userId], references: [id])

  @@unique([courseId, userId]) // 1ユーザーが1コースに複数回「食べたい」を付けられないようにする
  @@map("wants_to_eat")
}

// 9. コメント (comments)
model Comment {
  id                  Int                 @id @default(autoincrement())
  courseId            Int                 @map("course_id")
  userId              Int                 @map("user_id")
  content             String              @db.Text
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // リレーション
  course              Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user                User                @relation(fields: [userId], references: [id])

  @@map("comments")
}

// 10. 食べたよ履歴 (trieds)
model Tried {
  id                  Int                 @id @default(autoincrement())
  courseId            Int                 @map("course_id")
  userId              Int                 @map("user_id")
  createdAt           DateTime            @default(now()) @map("created_at")

  // リレーション
  course              Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user                User                @relation(fields: [userId], references: [id])

  @@unique([courseId, userId]) // 1ユーザーが1コースに複数回「食べたよ」を付けられないようにする
  @@map("trieds")
}

// 11. 問い合わせ（ContactSubmission）
// 問い合わせの種別を定義するEnum
enum SubmissionType {
  REQUEST     // 要望
  BUG_REPORT  // 不具合報告
  ACCOUNT     // アカウント関連
  OTHER       // その他
}

// 問い合わせの状態を定義するEnum
enum SubmissionStatus {
  OPEN        // 受付中
  IN_PROGRESS // 処理中
  RESOLVED    // 解決済み
  CLOSED      // クローズ
}

model ContactSubmission {
  id                  Int                 @id @default(autoincrement())
  // 問い合わせ者情報 (ログインユーザーの場合)
  userId              Int?                @map("user_id")// ログインユーザーID (任意)
  user                User?               @relation(fields: [userId], references: [id])
  // 問い合わせ者情報 (未ログインユーザーの場合)
  submitterName       String?             @map("submitter_name") // 氏名 (未ログイン時のみ使用)
  submitterEmail      String              @map("submitter_email") // 返信先メールアドレス (必須)
  // 問い合わせ内容
  type                SubmissionType
  title               String              @db.VarChar(255)
  details             String              @db.Text
  // 運営管理用
  status              SubmissionStatus    @default(OPEN) // 問い合わせの現在の状態  
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  
  @@map("contact_submissions") // テーブル名も複数形スネークケースに統一
}

// ====================================================================
// V. NextAuth.js (Auth.js) 用の追加モデル
// ====================================================================

model Account {
  id                  String  @id @default(cuid())
  userId              Int     @map("user_id")
  type                String
  provider            String
  providerAccountId   String  @map("provider_account_id")
  refresh_token       String? @db.Text
  access_token        String? @db.Text
  expires_at          Int?
  token_type          String?
  scope               String?
  id_token            String? @db.Text
  session_state       String? @map("session_state")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id                  String   @id @default(cuid())
  sessionToken        String   @unique @map("session_token")
  userId              Int      @map("user_id")
  expires             DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier          String
  token               String   @unique
  expires             DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}